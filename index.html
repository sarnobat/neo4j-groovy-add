<!DOCTYPE html>
<html>
<head>

<link rel="stylesheet" href="http://jqueryui.com/jquery-wp-content/themes/jqueryui.com/style.css">
<link rel="stylesheet" href="http://code.jquery.com/ui/1.11.0/themes/smoothness/jquery-ui.css">

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.js"></script>
<script src="jquery/jquery-1.9.1.js"></script>
<script src="jquery/jquery-ui.js"></script>

<script type="text/javascript" src="jquery/purl.js"></script>
<!-- we can't use the kb_shortcuts API because you can't keep the shift key held down in between keypresses -->
<script src="http://www.webtoolkit.info/djs/webtoolkit.md5.js"></script>
<style type="text/css">

.itemImage {
	padding : 10px;
}

.ui-widget {
	/* Reduces JQUery's default font size */
    font-size: 90%;
}

.ui-tabs .ui-tabs-panel {
	background-color : #EEEEEE;
}

circle.node {
  cursor: pointer;
  stroke: #000;
  stroke-width: .5px;
}

line.link {
  fill: none;
  stroke: #9ecae1;
  stroke-width: 1.5px;
}

    </style>
        <script type="text/javascript" src="d3/d3.js"></script>
    <script type="text/javascript" src="d3/d3.geom.js"></script>
    <script type="text/javascript" src="d3/d3.layout.js"></script>
    
<script>

var urlBase = "http://netgear.rohidekar.com:4447/yurl";
var rootId;
var parentOfRootId;
var orderedDescending = true;

//$(document).ready(showLinks({}));

function getBiggestImages() {
	$.getJSON("http://localhost:3000/biggestImages", function(result){
				//alert(JSON.stringify(result));
				showLinks(result);
			});
}

function showLinks(biggestImages) {

	////
	//// Determine the root ID
	////
	{
		getRootId: {
			rootId = $.url().param('rootId');
		}
	
		updateURL: {
			if (rootId == null || rootId == '') {
				rootId = 45;
				history.pushState(null, null, '/yurl?rootId=' + rootId) // HTML5
			}
		}
		
		setCountAndTitle: {
			$.getJSON(urlBase + "/count_non_recursive?rootId=" +rootId,function(result){
				$("#count").text(result.count);
				$("#category").text(result.name);
				document.title = result.name + " (yurl)";
			});
		}
	
		setParentOfRootId(rootId);
		
		showLoading : {
			$("#status").text("Loading")  			
		}

		setColorForCategory : {		
			var rootColor = MD5(rootId.toString()).substring(0,6);
			$("#rootColor").attr("style", "background-color: #" + rootColor);
		}
	
		var limit = $.url().param('limit')
		if (limit == null) {
			limit = 50;
			window.history.pushState("object or string", "Title", document.URL + "&limit=50");
		}
	}
	////
	//// Get the key bindings and categories (non-recursive)
	////
	var categories;
	
	setCategoriesAndConfigureKeyBindings : {
		$.getJSON(urlBase + "/keys?parentId=" + rootId, function(result){
			var originalKeyBindings = $.extend(true, {}, result);// TODO: what does this do?
			categories = result;	  
			configureKeyBindings(categories);
		});
	
		function configureKeyBindings(result) {
			$.each(result, function(a,binding,c){
				if (binding.key == 'null') {
					$("#keys").append("#");
					// Don't remove the "null" otherwise we'll assign hash to this category
				}
				$("#keys").append(binding.key + "=" + binding.name +" # node " + binding.id + "\n");
				$("#keyLinks").append("<li style='text-transform:capitalize;' id='list_"+binding.id+"'><a href='/yurl/?rootId=" + binding.id+ "'>" + " " + binding.name + " (<span id='count_"+binding.id+"'></span>)</a></li>");
				$("#count_" + binding.id).text(binding.count);
				$(window).keypress(function(event) {
					if ($("#keys").is(":focus")) {
						return;
					}
					if (binding.key == String.fromCharCode(event.which)) {
						var parentId = binding.id;
						var childId = $("#urls-cards").children()[0].id;
						var currentRootId = rootId;
						relate(parentId, childId, currentRootId);
					}
				});			
			});
			$(window).keypress(function(event) {
				var key = String.fromCharCode(event.which);
				if (('_' == key)||('-'==key) ||('j'==key)|| ('n' == key) ) {
					var idOfTop = $("#url_cards").children()[0].id;
					moveToBottom(idOfTop);
				}
				if (String.fromCharCode(event.which) == '<') {
					var parentId = parentOfRootId;
					var childId = $("#url_cards").children()[0].id;
					var currentRootId = rootId;
					relate(parentId, childId, currentRootId);
				}
				if (String.fromCharCode(event.which) == '>') {
					console.debug("remove from list (deal with it later)");
				}
			});
		}
	}
	
	////
	//// Uncategorized URLs (main part)
	////
    
    getUrls : {
		$.getJSON(urlBase + "/uncategorized?rootId=" +rootId,function(result){
			$("#status").text("Populating")
			var resultRowNumber = 0;
			$.each(result, function(resultRowNumber, field) {
				fillCardItem(resultRowNumber, field, result, limit, biggestImages, categories);
				fillThumbnailItem(resultRowNumber, field, result, limit, biggestImages, categories);
				++resultRowNumber;
			});
			$("#status").text("Done")
		});
	}
	    
    ////
    //// Get all recursive categories bindings
    ////
    
    // Unfortunately, there is no easy way to get a tree of all category nodes.
    // If this were an enterprise app, I'd go through the extra effort but for a 
    // toy app like this it's not worth the effort.
    var nodeIdZero = 0;
    getCategoriesTree : {
		var url = urlBase + "/categoriesRecursive?parentId=" + nodeIdZero;
		$.getJSON(url, function(result){})
			.success(
				function(data) { 
					  
					  renderVisualization(data.categoriesTree);
					  //renderVisualization(getData());
					  //drawVisualization(data.categoriesTree);
					  
					  writeCategoryTree(data.categoriesTree, 0);
					  $.each(data.flat, function(a,category,c){
							$("#categoriesRecursive").append("<input type=checkbox value=false name="+category.id +"><a href='/yurl/?rootId="+category.id+"' style='text-transform:capitalize;'>" + category.name + " (" + category.id + ")</a></input>");
							$("#categoriesRecursive").append("<br>");
						});
				}
			)
			.error(function() {  })
			.complete(function() {  }
		);
	}


	////
    //// Update the key bindings
    ////
    
    addKeyBindingsUpdateHandler : {
		var oldKeyBindings;
		$("#keys").focus(function() {
			console.debug('focus callback begin');
			oldKeyBindings = $.trim($("#keys").val());
			console.debug('focus callback');
		}).blur(function() {
			console.debug('blur callback');
			var newKeyBindings = $.trim($("#keys").val());
			var i = 1;
			var url;
			if (oldKeyBindings === newKeyBindings) {
			} else {
				url = urlBase + "/keysUpdate?parentId=" + $.url().param('rootId') + "&newKeyBindings=" + encodeURIComponent(newKeyBindings) + "&oldKeyBindings=" + encodeURIComponent(oldKeyBindings);
			}
			console.debug('sending ' + url);
			$.getJSON(url, function(result){})
				.success(function(data) {  
					configureKeyBindings(data);
				})
				.error(function() { })
				.complete(function() { });
		});
		console.debug('inside addKeyBindingsUpdateHandler function end...');
    }
	console.debug('finished declaring addKeyBindingsUpdateHandler function.');
    
}

function fillThumbnailItem(resultRowNumber, field, result, limit, biggestImages, categories) {
	if (resultRowNumber > limit && resultRowNumber < result.length - 10)  {
		return;
	}
	//console.debug(resultRowNumber);
	var toBeAppended = createImageCell(field, biggestImages, 100, resultRowNumber);
	$("#url_thumbnails").append(toBeAppended);
	
}

function fillCardItem(resultRowNumber, field, result, limit, biggestImages, categories) {
	if (resultRowNumber > limit && resultRowNumber < result.length - 10)  {
		return;
	}
	
	var one = $("<td style='background-color:'>1");
	var two = $("<td style='background-color:' >2");
	var three = $("<td style='background-color:'>3");
	var four = $("<td id='categoryButtonsCell' style='background-color:'>4");
	var five = $("<td style='background-color:'>5");
	
	var table = $("<table/>");
	{
		table.attr('width','100%');
	
		{
			var row1 = $("<tr/>");
			table.append(row1);
			row1.append(two);
			row1.append(three);
		}
	
		{
			var row2 = $("<tr/>");
			table.append(row2);
			row2.append(four);
			row2.append(five);
		}
	
		{
			var listItem = $("<li>").attr('id',field.id).attr("class",'buttonize').attr('style','background-color:#FDFD96');
			listItem.append(table);
			$("#url_cards").append(listItem);
		}
	
	}
	
	{
		var urlElements = field.url.match(/^http:\/\/[^/]+/);
		if (urlElements != null) {
			var site = urlElements[0];
			two.append("<img src='" + site + "/favicon.ico' width=18 onerror=\"this.style.display='none'\" > ");
		}
		two.append("<font style=\"color: #002366\">"+ field.title + "</font><br><sub><font style=\"color: #436B95\"><a href='" +field.url+"'>"+field.url+"</a></font></sub>");
	}
	
	var imageCell = createImageCell(field, biggestImages, 300, resultRowNumber);
	three.append(imageCell);
	
	{
		var buttonCell = two;
		buttonCell.append("<br>");
		buttonCell.append("<br>");
		buttonCell.append("<input type=button class='genericButton' value=Tag onClick='tagUrlWithSelections("+field.id+")'><br>");			
		buttonCell.append("<br>");
		buttonCell.append("<br>");
		buttonCell.append("<input type=button class='genericButton' value='Top' onclick='moveToTop("+field.id+")'><br>");
		buttonCell.append("<input type=button class='genericButton' value='Move Up' onclick='moveUp("+field.id+")'><br>");
		buttonCell.append("<input type=button class='genericButton' value='Move Down' onclick='moveDown("+field.id+")'><br>");
		buttonCell.append("<input type=button class='genericButton' value='Bottom' onclick='moveToBottom("+field.id+")'><br>");
		buttonCell.append("<sub>"+field.id+"</sub>");
	}
	
	{
		var categoryButtons = four;
		// TODO: 'categories' may not yet be set. Really we should add these buttons in the callback where "categories" is set. But we don't know the field ID unless we wait until the item results load
		$.each(categories, function(a,binding,c){
			categoryButtons.append("<input type=button class='genericButton' value='"+binding.name+"' onclick='relate("+binding.id+","+field.id+","+rootId+")'>&nbsp;");
		});						
	}
	
	{
		five.append("<input type=button class='genericButton' value='I own this' onclick='tagUrlWithCategoryIds("+field.id+",createArrayWithId("+37373+"), this)'><br>");
		five.append("<input type=button class='genericButton' value='Buy this' onclick='tagUrlWithCategoryIds("+field.id+",createArrayWithId("+221013+"), this)'><br>");
		five.append("<input type=button class='genericButton' value='Download this' onclick='tagUrlWithCategoryIds("+field.id+",createArrayWithId("+221026+"), this)'><br>");
		five.append("<input type=button class='genericButton' value='Watched' onclick='tagUrlWithCategoryIds("+field.id+",createArrayWithId("+37652+"), this)'><br>");
		five.append("<input type=button class='genericButton' value='Watch this' onclick='tagUrlWithCategoryIds("+field.id+",createArrayWithId("+37567+"), this)'><br>");
	}	
}

function createImageCell(field, biggestImages, imageSize, resultRowNumber) {

	var imageCell = "";
	var hasScreenshot = false;
	{
		if (field.url.match(".jpg\??") || 
			field.url.match(".gif$") || 
			field.url.match(".png\??") || 
			field.url.match("images.q=tbn:")) {
			imageCell += ("<img class=itemImage src="+field.url+" width="+imageSize+">");
			hasScreenshot = true;
		}
		if (field.url.match("youtube.com")) {
			if (field.url.match("youtube.com/watch")) {
				var youtubeId = field.url.replace(/^https?:..www.youtube.com.watch.*v=([^&]+).*/g,'$1');
				imageCell += ("");
				imageCell += ("<img class=itemImage src='http://img.youtube.com/vi/"+youtubeId+"/0.jpg' width="+imageSize+">");
				
				imageCell += ("");
				imageCell += ("");
				imageCell += ("");
				hasScreenshot = true;
			}
			
		} else if (field.url.match("dailymotion.com/video")) {
				var youtubeId = field.url.replace(/^http.*video.([^?]+)(.*)/g,'$1');
				imageCell += ("");
				imageCell += ("<img class=itemImage src='http://dailymotion.com/thumbnail/video/"+youtubeId +"' width="+imageSize+">");
				imageCell += ("");
				imageCell += ("");
				imageCell += ("");
				hasScreenshot = true;
			
		} else if (field.url.match(".amazon.co[^/]+\/[^s]")) {
			imageCell += ("");
			var asin = field.url.replace(/.+dp\/([^\/]+)\/?.*/,'$1');
			var productImageUrl = 'http://images.amazon.com/images/P/'+asin+'.01.LZZZZZZZ.jpg';
			imageCell += ("<img class=itemImage src='"+productImageUrl+"' height='280'>");
			hasScreenshot = true;
		}
	}
	
	if (!hasScreenshot) {
		imageCell += ("<img class=itemImage src=\"http://free.pagepeeker.com/v2/thumbs.php?size=x&url="+encodeURIComponent(field.url)+"\" class='screenshot' width="+imageSize+" />");
		// Check if the biggest image server is up
		if (biggestImages != null) {
			if (biggestImages[field.url] != null) {
				imageCell += ("<img class=itemImage src=\""+ biggestImages[field.url] +"\" class='screenshot' width="+imageSize+" />");
			}
		}
	}

	// Tooltip
	var img = $($.parseHTML(imageCell));
	img.tooltip({
		items: "img",
		content:  field.title + "<br><font style=\"font-size : xx-small \">"+field.url+"</font>",
	});	
	return img;
}

function relate(parentId, childId, currentRootId) {
	removeTop(parentId, childId);
	var url = urlBase + "/relate?parentId=" +parentId+"&childId=" +  childId + "&currentParentId=" + currentRootId;	
	//
	// The main part
	//
	$.getJSON(url, function(result){})
		.success(function() { 

			$("#list_"+parentId).effect("highlight", null, 4000, function() {});
			
			// Change the destination category count
			var count = parseInt($("#count_"+parentId).text()) + 1;
			$("#count_"+parentId).text(count);
			$("#count_"+parentId).css("font-weight","Bold");
			
			// Decrement the number of items in this category that is displayed
			var newCount = parseInt($("#count").text());
			newCount -= 1;
			$("#count").text(newCount);
		})
		.error(function() { alert("error occurred "); })
		.complete(function() { });
}

// This part just performs frontend changes, nothing backend
function removeTop(parentId, childId) {
	var target;
	if (parentId == parentOfRootId) {
		target = "#up";
	} else {
		target = "#list_"+parentId;
	}
	var options = { to: target, className: "ui-effects-transfer" };
	$($("#" + childId)).effect('transfer',options,50,function() { // !!!!!!!! TODO : Wrong. remove the one specified by child ID
		$($("#" + childId)).effect( "blind",null, 5, function() { $(this).remove(); });
	});	
}
  
function writeCategoryTree(root, level) {
	var indent = "";
	for (var i = 0; i < level; i++) {
		indent = indent + "&nbsp;&nbsp;&nbsp;&nbsp;";
	}
	$("#categoriesTree").append(indent + "<a href='/yurl/?rootId="+root.id+"' style='text-transform:capitalize;'>"+root.name + "</a>");
	$("#categoriesTree").append("<br>");
	
	if (root.children != null) {
		$.each(root.children, function(a,b){
			
			writeCategoryTree(b, level + 1);
		});
	}
}

function moveToTop(source) {
	var idToMove = source;
	var firstId = $("#url_cards").children().first().attr("id");


	if (orderedDescending) {
		var elem = $("#" + idToMove).remove();
		$("#url_cards").prepend(elem);
		// 1 more than latest timestamp
		$.getJSON(urlBase + "/surpassOrdinal?nodeIdToChange=" + idToMove + "&nodeIdToSurpass=" + firstId,
			function(result){
			})
			.success(function(data) {  
			})
			.error(function() {
				alert("error occurred "); 
			})
			.complete(function() { });
	} else {
		// 1 less than earliest timestamp
		alert('not implemented');
	}
}

function moveToBottom(source) {
	var idToMove = source;
	var lastId = $("#url_cards").children().last().attr("id");

	if (orderedDescending) {
		var elem = $("#" + idToMove).remove();
		$("#url_cards").append(elem);
		$.getJSON(urlBase + "/undercutOrdinal?nodeIdToChange=" + idToMove + "&nodeIdToUndercut=" + lastId, 
			function(result){
			})
			.success(function(data) {  
			})
			.error(function() {
				alert("error occurred "); 
			})
			.complete(function() { });
	} else {
		alert('not implemented');
	}
}

function moveUp(source) {
	var first = $("#" + source).prev().attr('id');
	var second = source;
	swap(first, second);
}

function moveDown(source) {
	var first = source;
	var second = $("#" + source).next().attr('id');
	swap(first, second);
}

function swap(firstId, secondId) {
	$.getJSON(urlBase + "/swapOrdinals?firstId=" + firstId + "&secondId=" + secondId, 
		function(result){
		})
		.success(function(data) {  
			$("#" + secondId).after($("#" + firstId));
		})
		.error(function() { 
			alert("error occurred "); 
		})
		.complete(function() { 
		});

}

function sendBatch() {
	var urls = encodeURIComponent($("#urlBatchToSend").val());
	$("#batchStatus").text("Sending new batch");	
	$.getJSON(urlBase + "/batchInsert?rootId=" + rootId + "&urls=" + urls, function(result){})
		.success(function(data) {
			$("#batchStatus").text("Successfully imported batch, except for ones remaining in text box");
			$("#urlBatchToSend").val("");
			$("#urlBatchToSend").val(data.unsuccessful);
		})
		.error( function(data) {
			alert("error occurred "); 
		} )
		.complete( function() {} );
}

function createArrayWithId(id) {
	var selected = new Array();
	selected.push(id);
	return JSON.stringify(selected);
}


function getTagSelections() {
	var selected = new Array();
	$('#categoriesRecursive input:checked').each(function() {
		selected.push($(this).attr('name'));
	});
	return JSON.stringify(selected);
}

function tagUrlWithSelections(nodeId) {
	var selections = getTagSelections();
	tagUrlWithCategoryIds(nodeId, selections);
}

function tagUrlWithCategoryIds(nodeId, selections, button) {
	var url = urlBase + "/relateCategoriesToItem?nodeId=" + nodeId + "&newCategoryIds=" + encodeURIComponent(selections);
	$.getJSON(url, 
		function(result){
		})
		.success(function(data) {  
			//$("#"+nodeId).remove();
			button.style.cssText = "background-color : green";
		})
		.error(function() { 
			alert("error occurred "); 
		})
		.complete(function() { 
		}
	);
}

function setParentOfRootId(nodeId) {    	
	$.getJSON(urlBase + "/parent?nodeId=" + nodeId, function(result){
	})
	.success(function(data) {  
		if (data[0] != null) {
			parentOfRootId = data[0].id;
			$("#up").attr("href", "/yurl/?rootId=" + parentOfRootId);
		}
	})
	.error(function() { })
	.complete(function() { });
}

function drawVisualization(data) {
	console.debug(data);
	//alert(JSON.stringify(data));
	var ua = navigator.userAgent;
	var forceDirectedGraph = new $jit.ForceDirected({
		injectInto: 'infovis',
		Node: {
			overridable: true
		},
		Edge: {
			overridable: true,
		},
		Label: {  
			type: 'Native', //Native or HTML  
			size: 5,  
			style: 'bold'  
		  },
		Navigation: {  
			enable: true,  
			//Enable panning events only if we're dragging the empty  
			//canvas (and not a node).  
			panning: 'avoid nodes',  
			zooming: 10 //zoom speed. higher is more sensible  
		},
	});

	var listOfNodes;
  
	{
		var adjacenciesList = [];
		for (var i = 0; i < data.children.length; i++) {
			adjacenciesList[i] = { "nodeTo" : data.children[i].id };
		}
		
		
		listOfNodes = [{
		
			id:45,
			data : {
				"$color"		:	"#C74243",
				"$type"			:	"star",
				"$dim"			: 	17
			},
			adjacencies : adjacenciesList
		}];
		
		addNodes(data, listOfNodes, 0);
	}

	//console.debug("List of nodes...");
	//console.debug(listOfNodes);
	
	forceDirectedGraph.loadJSON(listOfNodes); 

	forceDirectedGraph.computeIncremental({
		onComplete: function(){
			forceDirectedGraph.animate(function(){ });
		}
	});
	 
}

function addNodes(data, listOfNodes, level1) {
	if (data.children == null) {
		return;
	}
	++level1;
	for (var i = 0; i < data.children.length; i++) {
		var category = data.children[i];
		listOfNodes.push({ 
			id : category.id,
			name : category.name,
			"level" : level1,
			data : {
				"$color"		:	getColorForLevel(level1),
				"$type"			:	getShapeForLevel(level1),
				"$dim"			: 	4
			},
			adjacencies : getAdjacencies(category),
		});
		
		addNodes(category, listOfNodes, level1);
	}
}


function getColorForLevel(level) {
	if (level == 1) {
		return "red";
	}
	if (level == 2) {
		return "green";
	}
	if (level == 3) {
		return "blue";
	}
	return "yellow";
	
}

function getShapeForLevel(level) {
	if (level == 1) {
		return "star";
	}
	if (level == 2) {
		return "square";
	}
	if (level == 3) {
		return "triangle";
	}
	return "circle";
	
}

function getAdjacencies(category) {
	var adjacenciesList = [];
	
	if (category.children !=null) {
		for (var i = 0; i < category.children.length; i++) {
			adjacenciesList[i] = { "nodeTo" : category.children[i].id };
		}
	}
	return adjacenciesList;
}

// TODO: Remove. Unused
function addEmbeddedVideo(id, url) {
	$("#" + id).children().last().append("<iframe width=420 height=345 src="+url.replace("watch?v=","embed/")+"></iframe>");
}

function getData() {
	return {"id":45,"name":"root","children":[{"id":46440,"name":"art, graphics and design","size":92},{"id":38907,"name":"priority 3","size":1},{"id":37658,"name":"youtube playlists","children":[{"id":138633,"name":"productivity","size":5},{"id":138632,"name":"health","size":10},{"id":138631,"name":"science","size":18},{"id":138630,"name":"food"},{"id":109186,"name":"animals","size":71},{"id":106716,"name":"other","size":142},{"id":106044,"name":"Self Help","size":37},{"id":106043,"name":"Home","size":22},{"id":105985,"name":"Products & Services","size":4},{"id":105984,"name":"Entertainment","size":296},{"id":95704,"name":"non-youtube","size":20},{"id":95702,"name":"Travel","size":86},{"id":95701,"name":"history","size":9},{"id":95700,"name":"technology","size":108},{"id":83074,"name":"business","size":37},{"id":37817,"name":"wrestling","children":[{"id":129025,"name":"matches"},{"id":129024,"name":"vignettes","size":16},{"id":129023,"name":"PPV","size":12},{"id":129021,"name":"documentary","size":17},{"id":129020,"name":"broadcasts","size":28},{"id":129019,"name":"interviews","size":81},{"id":129018,"name":"songs","size":20},{"id":129017,"name":"divas","size":34},{"id":37818,"name":"volumes","size":6}],"size":410},{"id":37761,"name":"soccer","children":[{"id":95564,"name":"youth","size":1},{"id":95562,"name":"music","size":6},{"id":95560,"name":"International","size":15},{"id":95559,"name":"Nostalgia","size":15},{"id":95558,"name":"European","size":14},{"id":95530,"name":"Liverpool","size":25},{"id":85980,"name":"documentaries","children":[{"id":37814,"name":"managers","size":3},{"id":37816,"name":"owners","size":3},{"id":37815,"name":"clubs","size":4},{"id":37812,"name":"players","size":13},{"id":37813,"name":"rivalries","size":15}],"size":15},{"id":83607,"name":"Atletico Madrid","children":[{"id":105300,"name":"1950s","size":1},{"id":105299,"name":"1940s","size":2},{"id":105298,"name":"1970s","size":5},{"id":95541,"name":"2010s","size":16},{"id":95540,"name":"2000s","size":17},{"id":95539,"name":"1980s","size":10},{"id":95538,"name":"1960s","size":10},{"id":84404,"name":"1990s","children":[{"id":105307,"name":"1996-1997","size":5},{"id":105306,"name":"1993-1994","size":9},{"id":105305,"name":"1998-1999","size":1},{"id":105304,"name":"1990","size":1},{"id":105303,"name":"1992-1993","size":7},{"id":105302,"name":"1991-1992","size":5},{"id":105301,"name":"1990-1991","size":6}],"size":15},{"id":83610,"name":"friendly","size":92},{"id":83609,"name":"Copa del Rey","size":57},{"id":83608,"name":"Europe","children":[{"id":95537,"name":"2010s","size":2},{"id":95536,"name":"1960s","size":3},{"id":95535,"name":"1980s","size":15},{"id":95534,"name":"2000s","size":2},{"id":95533,"name":"1990s","size":35},{"id":95532,"name":"1970s","size":23}],"size":11}],"size":163},{"id":83218,"name":"tournaments","children":[{"id":83222,"name":"1994 USA","size":28},{"id":83219,"name":"1990 Italy","size":47}],"size":21}],"size":1166},{"id":37700,"name":"favorites","children":[{"id":37740,"name":"trash","size":8}],"size":10},{"id":37659,"name":"documentaries","children":[{"id":37833,"name":"technology","size":9},{"id":37832,"name":"self","size":6},{"id":37831,"name":"business","size":4},{"id":37830,"name":"health","size":11},{"id":37829,"name":"travel","size":7}],"size":22}],"size":126},{"id":37581,"name":"download these","children":[{"id":37628,"name":"trash","size":1}],"size":57},{"id":37568,"name":"watched","size":5},{"id":37567,"name":"watch these","children":[{"id":37652,"name":"watched","size":12},{"id":37651,"name":"trash","size":4}],"size":40},{"id":32881,"name":"legal","size":2},{"id":30281,"name":"animals and nature","children":[{"id":32805,"name":"dogs","size":2},{"id":32804,"name":"cats","size":9}],"size":58},{"id":30254,"name":"humor","size":113},{"id":30253,"name":"Humor"},{"id":30196,"name":"career","children":[{"id":101457,"name":"academic","children":[{"id":101458,"name":"disciplines","children":[{"id":101459,"name":"history of world in 2 hours","size":52}],"size":1}],"size":1}],"size":94},{"id":29196,"name":"products and services","children":[{"id":221121,"name":"services"},{"id":221120,"name":"food","size":4},{"id":221018,"name":"video","children":[{"id":221119,"name":"soccer","size":3},{"id":37905,"name":"wrestling","children":[{"id":37906,"name":"DVDs","children":[{"id":37981,"name":"divas","size":7},{"id":37978,"name":"anthologies","size":15},{"id":37977,"name":"lists","size":8},{"id":37907,"name":"documentaries","children":[{"id":38002,"name":"watched","size":37}],"size":48}],"size":41}],"size":18}],"size":63},{"id":221118,"name":"productivity","size":27},{"id":221117,"name":"housewares","size":43},{"id":221089,"name":"stores","size":6},{"id":221028,"name":"clothing","size":18},{"id":221027,"name":"toys","size":19},{"id":221026,"name":"download","size":14},{"id":221016,"name":"audio","size":59},{"id":221015,"name":"cosmetics","size":50},{"id":221014,"name":"Soccer","size":4},{"id":221013,"name":"buy these","size":21},{"id":38044,"name":"books","children":[{"id":221113,"name":"productivity and learning","size":15},{"id":221025,"name":"fashion","size":2},{"id":221024,"name":"wrestling","size":6},{"id":221023,"name":"travel","size":7},{"id":221022,"name":"self","size":33},{"id":221020,"name":"soccer","size":19},{"id":102854,"name":"other","size":3},{"id":38114,"name":"business","size":83},{"id":38045,"name":"technology","size":150}],"size":274},{"id":37452,"name":"stationery","size":41},{"id":37375,"name":"electronics","size":137},{"id":37373,"name":"owned","children":[{"id":83004,"name":"design, graphics","size":1},{"id":83003,"name":"technology","size":1},{"id":83002,"name":"business","size":4}],"size":106},{"id":37248,"name":"trash","size":46}],"size":53},{"id":29172,"name":"other","children":[{"id":101353,"name":"videos","size":60},{"id":36967,"name":"trash","size":126},{"id":30363,"name":"indian","size":49},{"id":30279,"name":"teen","size":127}],"size":5723},{"id":29171,"name":"productivity","size":90},{"id":28975,"name":"entertainment","children":[{"id":46172,"name":"Indian","children":[{"id":46173,"name":"home video","children":[{"id":46174,"name":"Mona Khan","size":9}],"size":1}],"size":1},{"id":37556,"name":"transformers","size":43},{"id":30274,"name":"stock music","children":[{"id":37130,"name":"mitja mithans","size":3}],"size":9},{"id":30273,"name":"computer games","size":3},{"id":30272,"name":"movies","size":1},{"id":13335,"name":"wrestling","children":[{"id":37559,"name":"videos","children":[{"id":55225,"name":"Saturday Nights Main Event","children":[{"id":64434,"name":"trash","size":2}],"size":28},{"id":46124,"name":"famous segments","size":14},{"id":37655,"name":"Main Event","size":1},{"id":37653,"name":"prime time wrestling","size":1},{"id":37565,"name":"pre-shows","children":[{"id":46815,"name":"1992","size":4},{"id":46814,"name":"1990","size":4},{"id":46812,"name":"1991","size":5},{"id":46811,"name":"1993","size":5},{"id":46810,"name":"1994","children":[{"id":46813,"name":"trash","size":1}],"size":6},{"id":46809,"name":"1997","size":8},{"id":46808,"name":"1996","size":12},{"id":46807,"name":"1995","size":8},{"id":46806,"name":"1998","size":3},{"id":37656,"name":"downloaded"}],"size":14}],"size":171},{"id":37189,"name":"products and services","children":[{"id":37444,"name":"VHS","size":7}],"size":13}],"size":63}],"size":566},{"id":28974,"name":"health","size":129},{"id":28973,"name":"sports","children":[{"id":30441,"name":"soccer","children":[{"id":37644,"name":"atletico madrid","children":[{"id":46270,"name":"2013-2014","children":[{"id":46349,"name":"staff","size":15},{"id":46348,"name":"angled","size":26}],"size":27}],"size":29},{"id":37640,"name":"domestic","children":[{"id":37641,"name":"italy","children":[{"id":37642,"name":"coppa italia","size":1}],"size":1}],"size":1},{"id":37637,"name":"europe","children":[{"id":37638,"name":"cup winners cup","size":1}],"size":1},{"id":37634,"name":"liverpool","size":6},{"id":37629,"name":"confederations cup","children":[{"id":37630,"name":"finals","size":3}],"size":1}],"size":75}],"size":645},{"id":28972,"name":"friends","children":[{"id":102980,"name":"other","size":1},{"id":46350,"name":"personal","children":[{"id":46351,"name":"my photos","children":[{"id":46352,"name":"print these","children":[{"id":46383,"name":"files","size":30}],"size":31}],"size":1}],"size":4},{"id":30258,"name":"girls","size":76},{"id":30257,"name":"relatives","size":2},{"id":30256,"name":"personal development","size":14},{"id":30255,"name":"humor","size":28}],"size":323},{"id":28783,"name":"personal development","size":1074},{"id":48,"name":"trash","size":398},{"id":47,"name":"business","children":[{"id":38167,"name":"non-profit","size":4},{"id":38166,"name":"clean tech","size":12},{"id":38165,"name":"structure","size":6},{"id":38164,"name":"manufacturing, distribution & supply chain","size":16},{"id":38163,"name":"strategy","size":2},{"id":38162,"name":"management and leadership","size":3},{"id":38161,"name":"management"},{"id":38160,"name":"negotiations","size":1},{"id":38159,"name":"decisions","size":3},{"id":38158,"name":"innovation","size":21},{"id":38157,"name":"industries"},{"id":38156,"name":"companies","size":6},{"id":38155,"name":"finance","size":13},{"id":37987,"name":"HBS cases","size":14},{"id":28781,"name":"branding","size":17},{"id":28780,"name":"marketing","size":18}],"size":997},{"id":46,"name":"technology","children":[{"id":83620,"name":"design","size":14},{"id":46585,"name":"building","size":1},{"id":30199,"name":"hardware","size":3},{"id":30198,"name":"websites (internet)","size":2},{"id":30197,"name":"products and services","size":7},{"id":28976,"name":"science","size":31},{"id":28802,"name":"code reading","size":2},{"id":28793,"name":"c programming","size":6},{"id":28786,"name":"web programming and design","size":7},{"id":28785,"name":"applications","children":[{"id":84062,"name":"video editing"}],"size":40},{"id":28784,"name":"trash","size":1},{"id":28776,"name":"source control","size":8},{"id":28767,"name":"mac","size":12},{"id":28766,"name":"visualization","size":9},{"id":28765,"name":"linux","size":23},{"id":28764,"name":"databases","children":[{"id":28804,"name":"data sets","size":11},{"id":28803,"name":"graph databases","size":52}],"size":69},{"id":28763,"name":"concepts","children":[{"id":28797,"name":"operating systems","size":6}],"size":20},{"id":28762,"name":"java","children":[{"id":28809,"name":"code samples","size":9},{"id":28808,"name":"apis","size":12}],"size":66},{"id":28761,"name":"javascript","size":39}],"size":5468},{"id":28754,"name":"travel","children":[{"id":30362,"name":"language","size":1}],"size":380}],"size":3786};
}

function renderVisualization(flareJson) {
	var w = 680,
		h = 500,
		node,
		link,
		root;
	
	
	var force = d3.layout.force()
		.on("tick", tick) // Without this there is no recursive layout, and the graph just stays in one disorganized mess
	//    .charge(function(d) { return d._children ? -d.size / 100 : -30; })
	//    .linkDistance(function(d) { return d.target._children ? 80 : 30; })
		.size([w, h - 160])
		;
	
	var vis = d3.select("#d3").append("svg:svg")
		.attr("width", w)
		.attr("height", h);
	$("#d3").hide();
	
	
	// populate the graph with our input data
	{
	  root = flareJson;
	  root.fixed = true;
	  root.x = w / 2;
	  root.y = h / 2 - 80;
	  update();
	}
	
	// When an internal node is clicked to collapse the children, or initial load
	function update() {
	  var nodes = flatten(root),
		  links = d3.layout.tree().links(nodes);
	
	  // Restart the force layout.
	  force
		  .nodes(nodes)
		  .links(links)
		  .start();
	
	  // Update the links…
	  link = vis.selectAll("line.link")
		  .data(links, function(d) { return d.target.id; });
	
	  // Enter any new links.
	  link.enter().insert("svg:line", ".node")
		  .attr("class", "link")
		  .attr("x1", function(d) { return d.source.x; })
		  .attr("y1", function(d) { return d.source.y; })
		  .attr("x2", function(d) { return d.target.x; })
		  .attr("y2", function(d) { return d.target.y; });
	
	  // Exit any old links.
	  link.exit().remove();
	
	  // Update the nodes…
	  node = vis.selectAll("circle.node")
		  .data(nodes, function(d) { return d.id; })
		  .style("fill", color);
	
	  node.transition()
		  .attr("r", function(d) { 
			return d.size > 0 ? Math.max(Math.sqrt(d.size), 4.5) : 4.5;
		  });
	
	  // Enter any new nodes.
	  node.enter().append("svg:circle")
		  .attr("class", "node")
		  .attr("cx", function(d) { return d.x; })
		  .attr("cy", function(d) { return d.y; })
		  .attr("r", function(d) { 
			return d.size > 0 ? Math.max(Math.sqrt(d.size), 4.5) : 4.5;
		  })
		  .style("fill", color)
		  .on("click", click)
		  .call(force.drag);      
	
	  // Exit any old nodes.
	  node.exit().remove();
	}
	
	function tick() {
	  link.attr("x1", function(d) { return d.source.x; })
		  .attr("y1", function(d) { return d.source.y; })
		  .attr("x2", function(d) { return d.target.x; })
		  .attr("y2", function(d) { return d.target.y; });
	
	  node.attr("cx", function(d) { return d.x; })
		  .attr("cy", function(d) { return d.y; });
	}
	
	// Color leaf nodes orange, and packages white or blue.
	function color(d) {
	  return d._children ? "red" : d.children ? "green" : "yellow";
	}
	
	// Toggle children on click.
	function click(d) {
	 console.debug(d.name);
	  if (d.children) {
		d._children = d.children;
		d.children = null;
	  } else {
		d.children = d._children;
		d._children = null;
	  }
	  update();
	}
	
	// Returns a list of all nodes under the root.
	function flatten(root) {
	  var nodes = [], i = 0;
	
	  function recurse(node) {
		if (node.children) node.size = node.children.reduce(function(p, v) { return p + recurse(v); }, 0);
		if (!node.id) node.id = ++i;
		nodes.push(node);
		return node.size;
	  }
	
	  root.size = recurse(root);
	  return nodes;
	}
}

$(function() {
	$( "#tabs" ).tabs();
});



</script>
<style>
.ui-effects-transfer { border: 2px dotted gray; }

body{
	font-family:Verdana; font-size: 12px;
	//text-shadow:4px 4px #eeeeee;
	background-color:#eeeeee
}

.genericButton {
	background-color: #FDFD96;
}


.buttonize {
	//padding:20px;
	margin:25px;
	border-radius: 15px;
	box-shadow:
		inset 0 0 9px #222222, 
		10px 10px 14px #999999;// internal and external shadow
	background-color:#fafafa
}

.screenshot {
	padding:0px;
	margin:0px;
	border-radius: 15px;
	box-shadow:
		inset 0 0 9px #222222, 
		0px 0px 0px #999999;// internal and external shadow
	background-color:#fafafa
}
</style>

<script language="javascript" type="text/javascript" src="http://philogb.github.io/jit/static/v20/Jit//jit-yc.js"></script>
<link type="text/css" href="http://philogb.github.io/jit/static/v20/Jit/Examples/css/base.css" rel="stylesheet" />

</head>
<body onload='showLinks({})'>
	<br>
	<br>
	<table>
		<tr><td>
			<div id="queue"></div>
		</td><td>
			<table style="width: 100%;table-layout: fixed;">
				<tr>
					<td width="25%" valign=top>
						<a id="up">Up</a>
						<a href="http://netgear.rohidekar.com:4447/yurl/dumpurls">Export</a>
						<div id=rootColor class="buttonize">
							<center>
								<br><h2><span id="category"></span>(<span id="count"></span>)<br></h2><br>
							</center>
						</div>
						<ol id="keyLinks"  class="buttonize" style="" ></ol>
						<font color=grey><div id="status">Init</div></font>
						<textarea id="keys" cols="34" rows="20px" class="buttonize"></textarea>
						<!-- I don't see a good reason to have both of these. Hopefully JSON Tree
							will replace both -->
						<br>Tree of Categories<br>
						<div id="categoriesTree"  class="buttonize"></div>
						<br>Category tags<br>
						<div id="categoriesRecursive"  class="buttonize">
						<br><br>

						<br><br>
						</div>
						
					</td>
					
					<td width="75%" style="vertical-align: top">
						<div id="tabs">
							  <ul>
								<li><a href="#tabs-1">Cards</a></li>
								<li><a href="#tabs-2">Grid</a></li>
								<li><a href="#tabs-3">List</a></li>
							  </ul>
							  <div id="tabs-1">
								  <ol id="url_thumbnails"></ol>
							  </div>
							  <div id="tabs-2">
								  <ol id="url_cards"></ol>
							  </div>
							  <div id="tabs-3">
							  </div>
						</div>
						<button type=button onclick='$("#d3").toggle()'>Show visualization</button>
						<div id="d3" style="background-color:grey"></div>
						<!--<div id="infovis" style="background-color : black"></div>    -->
						
						<input type="button" value="Add URLs" onclick="sendBatch()" /><br>
						<div id="batchStatus"></div>
						<textarea id="urlBatchToSend" rows="20" cols="100"></textarea>
						
					</td>
				</tr>
				<tr>
					<td></td>
					<td>
					</td>
				</td>
			</table>	
		</td></tr>
	<table>
</body>
</html>
