<!DOCTYPE html>
<html>
<head>
<!-- <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"><script> -->
<script src="jquery/jquery-1.9.1.js"></script>
<script type="text/javascript" src="jquery/purl.js"></script>
<!-- we can't use the kb_shortcuts API because you can't keep the shift key held down in between keypresses -->
<script>
var urlBase = "http://netgear.rohidekar.com:4447/yurl";
var rootId;
var originalKeyBindings;
$(document).ready(function() {

	//// Determine the root ID
	var rootId = $.url().param('rootId')
	if (rootId == null || rootId == '') {
		rootId = 45;
		history.pushState(null, null, '/yurl?rootId=' + rootId) // HTML5
	}
	$("#status").text("Loading")  			

	//// Get the URLs belonging to this root ID
    $.getJSON(urlBase + "/uncategorized?rootId=" +rootId,function(result){
      $("#status").text("Populating")
      $.each(result, function(resultRowNumber, field){
        $("#urls").append("<li id="+field.id+">[" + field.id + "]: "+ field.title + " (" + field.url + ") " + "</li>");
      });
	  $("#status").text("Done")
    });

	//// Get the key bindings
  	$.getJSON(urlBase + "/keys?parentId=" + rootId, function(result){
  	  originalKeyBindings = $.extend(true, {}, result);
  	  configureKeyBindings(result);

  	  
    });
    function configureKeyBindings(result) {
      $.each(result, function(a,binding,c){
        $("#keys").append(binding.key + "=" + binding.name +" # node " + binding.id + "\n");
        $(window).keypress(function(event) {
        	if ($("#keys").is(":focus")) {
        		return;
        	}
        	if (binding.key == String.fromCharCode(event.which)) {
				var url = urlBase + "/relate?parentId=" +binding.id+"&childId=" +  $("#urls").children()[0].id + "&currentParentId=" + rootId;
				$.getJSON(url, function(result){})
					.success(function() { $($("#urls").children()[0]).fadeOut("slow",function() { $(this).remove(); }) })
					.error(function() { alert("error occurred "); })
					.complete(function() { });
			}
			
		});
      });
    };

    //// Update the key bindings
    var oldKeyBindings;
    $("#keys").focus(function() {
    	oldKeyBindings = $.trim($("#keys").val());
    }).blur(function() {
    	var newKeyBindings = $.trim($("#keys").val());
    	var i = 1;
    	if (oldKeyBindings === newKeyBindings) {
    		//alert("not changed");
    	} else {
			var url = urlBase + "/keysUpdate?parentId=" + $.url().param('rootId') + "&newKeyBindings=" + encodeURIComponent(newKeyBindings) + "&oldKeyBindings=" + encodeURIComponent(oldKeyBindings);
    		//alert(url);
    	}

		$.getJSON(url, function(result){})
			.success(function(data) {  
				//alert(data);
				configureKeyBindings(data);
			})
			.error(function() { //alert("error occurred "); 
			})
			.complete(function() { });
    });
});


</script>
</head>
<body>
	<table width="100%"><tr>
		<td width="25%" valign=top>
			Key bindings<br>
			<textarea id="keys" rows="10px"></textarea>
			<br><br>
		</td>
		<td width="75%">
			<font color=grey><div id="status">Init</div></font>
			<ol id="urls"></ol>
		</td>
	</tr></table>
</body>
</html>
