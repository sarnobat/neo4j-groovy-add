<!DOCTYPE html>
<html>
<head>
<style>
    .ui-effects-transfer { border: 2px dotted gray; }

body{
	font-family:Verdana; font-size: 12px;
	//text-shadow:4px 4px #eeeeee;
	background-color:#eeeeee
}

.genericButton {
	background-color: #FDFD96;
}


.buttonize {
	padding:20px;
	margin:25px;
	border-radius: 15px;
	box-shadow:
		inset 0 0 9px #222222, 
		10px 10px 14px #999999;// internal and external shadow
	background-color:#fafafa
}

.screenshot {
	padding:0px;
	margin:0px;
	border-radius: 15px;
	box-shadow:
		inset 0 0 9px #222222, 
		0px 0px 0px #999999;// internal and external shadow
	background-color:#fafafa
}
</style>
<!-- <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"><script> -->



<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.js"></script>
<!--
<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>-->
<script src="jquery/jquery-1.9.1.js"></script>
<script src="jquery/jquery-ui.js"></script>


<script type="text/javascript" src="jquery/purl.js"></script>
<!-- we can't use the kb_shortcuts API because you can't keep the shift key held down in between keypresses -->
<script src="http://www.webtoolkit.info/djs/webtoolkit.md5.js"></script>
<script>
console.debug("begin");

var urlBase = "http://netgear.rohidekar.com:4447/yurl";
var nodeIdZero = 0;
var rootId;
var originalKeyBindings;
var parentOfRootId;
var orderedDescending = true;

function addEmbeddedVideo(id, url) {
	$("#" + id).children().last().append("<iframe width=420 height=345 src="+url.replace("watch?v=","embed/")+"></iframe>");
}

$(document).ready(function() {

	console.debug("Determining root");

	////
	//// Determine the root ID
	////
	
	rootId = $.url().param('rootId');

	console.debug("Found root: " + rootId);

	if (rootId == null || rootId == '') {
		rootId = 45;
		history.pushState(null, null, '/yurl?rootId=' + rootId) // HTML5
		console.debug('added root ID');
	}
	$.getJSON(urlBase + "/count_non_recursive?rootId=" +rootId,function(result){
		$("#count").text(result.count);
		$("#category").text(result.name);
	});

	parentOfRootId = getParentId(rootId);
	$("#status").text("Loading")  			
	
	console.debug('Setting banner color to md5 of ' + rootId);
	
	var rootColor = MD5(rootId.toString()).substring(0,6);
	console.debug('Got substring');
	$("#rootColor").attr("style", "background-color: #" + rootColor);

	console.debug('About to read limit');

	var limit = $.url().param('limit')
	if (limit == null) {
		limit = 50;
		window.history.pushState("object or string", "Title", document.URL + "&limit=50");
	}

	////
	//// Uncategorized URLs
	////
    
	$.getJSON(urlBase + "/uncategorized?rootId=" +rootId,function(result){
		$("#status").text("Populating")
		$.each(result, function(resultRowNumber, field) {
			console.debug("resultRowNumber:  "+ resultRowNumber + " of " + result.length);
			if (resultRowNumber > limit && resultRowNumber < result.length - 10)  {
				return;
			}
			// Colors
			var color = "";
			var titlePlusUrl = field.title + field.url;
			
			var one = $("<td style='background-color:'>1");
			var two = $("<td style='background-color:' >2");
			var three = $("<td style='background-color:'>3");
			var four = $("<td style='background-color:'>4");
			
			var table = $("<table/>");
			table.attr('width','100%');
			var row1 = $("<tr/>");
			table.append(row1);
			row1.append(two);
			row1.append(three);
			var row2 = $("<tr/>");
			table.append(row2);
			row2.append(one);
			row2.append(four);


			var listItem = $("<li>").attr('id',field.id).attr("class",'buttonize').attr('style','background-color:#FDFD96');
			listItem.append(table);
			$("#urls").append(listItem);

			var urlElements = field.url.match(/^http:\/\/[^/]+/);
			if (urlElements != null) {
				var site = urlElements[0];
				two.append("<img src='" + site + "/favicon.ico' width=18 onerror=\"this.style.display='none'\" > ");
			}
			
			var urlRoot = field.url.replace(/.*:(\/\/[^\/]+).*/ig,"$1");
			two.append("<font style=\"color: #002366\">"+ field.title + "</font><br><sub><font style=\"color: #436B95\"><a href='" +field.url+"'>"+field.url+"</a></font></sub>");
			
			var hasScreenshot = false;
			var imageSize = 300;
			var imageCell = three;
			if (field.url.match(".jpg\??") || 
				field.url.match(".gif$") || 
				field.url.match(".png\??") || 
				field.url.match("images.q=tbn:")) {
				imageCell.append("<br><img src="+field.url+" width="+imageSize+">");
				hasScreenshot = true;
			}
			if (field.url.match("youtube.com")) {
				if (field.url.match("youtube.com/watch")) {
					var youtubeId = field.url.replace(/^https?:..www.youtube.com.watch.*v=([^&]+).*/g,'$1');
					imageCell.append("<br>");
					imageCell.append("<img src='http://img.youtube.com/vi/"+youtubeId+"/0.jpg' width="+imageSize+">");
					
					imageCell.append("<br>");
					//three.append("<img src='http://img.youtube.com/vi/"+youtubeId+"/1.jpg'>");
					//three.append("<img src='http://img.youtube.com/vi/"+youtubeId+"/2.jpg'>");
					//three.append("<img src='http://img.youtube.com/vi/"+youtubeId+"/3.jpg'>");
					//three.append("<div id=\"youtube-"+field.id+"\"><span href='#' onclick='addEmbeddedVideo(\"youtube-"+field.id+"\",\""+field.url+"\")'>Expand</span></div>");
					imageCell.append("");
					imageCell.append("");
					hasScreenshot = true;
				}
				
			} else if (field.url.match("dailymotion.com/video")) {
					var youtubeId = field.url.replace(/^http.*video.([^?]+)(.*)/g,'$1');
					imageCell.append("<br>");
					imageCell.append("<img src='http://dailymotion.com/thumbnail/video/"+youtubeId +"' width="+imageSize+">");
					imageCell.append("<br>");
					imageCell.append("");
					imageCell.append("");
					hasScreenshot = true;
				
			} else if (field.url.match(".amazon.co[^/]+\/[^s]")) {
				imageCell.append("<br>");
				var asin = field.url.replace(/.+dp\/([^\/]+)\/?.*/,'$1');
				var productImageUrl = 'http://images.amazon.com/images/P/'+asin+'.01.LZZZZZZZ.jpg';
				imageCell.append("<img src='"+productImageUrl+"' height='280'>");
				hasScreenshot = true;
			}

			
						
			if (!hasScreenshot) {
				imageCell.append("<img src=\"http://free.pagepeeker.com/v2/thumbs.php?size=x&url="+encodeURIComponent(field.url)+"\" class='screenshot' width="+imageSize+" /><br>");
				//three.append("<img src=\"http://images.shrinktheweb.com/xino.php?stwembed=1&stwaccesskeyid=82fb36a7ba73189&stwsize=xlg&stwurl="+encodeURIComponent(field.url)+"\" align=right width=200 />");
			}

			var buttonCell = two;
			buttonCell.append("<br>");
			buttonCell.append("<br>");
			buttonCell.append("<input type=button class='genericButton' value=Tag onClick='tagUrlWithSelections("+field.id+")'><br>");			
			buttonCell.append("<br>");
			buttonCell.append("<br>");
			buttonCell.append("<input type=button class='genericButton' value='Top' onclick='moveToTop("+field.id+")'><br>");
			buttonCell.append("<input type=button class='genericButton' value='Move Up' onclick='moveUp("+field.id+")'><br>");
			buttonCell.append("<input type=button class='genericButton' value='Move Down' onclick='moveDown("+field.id+")'><br>");
			buttonCell.append("<input type=button class='genericButton' value='Bottom' onclick='moveToBottom("+field.id+")'><br>");
			buttonCell.append("<sub>"+field.id+"</sub>");


		});
		$("#status").text("Done")
	});

	////
	//// Get the key bindings and categories (non-recursive)
	////
	
  	$.getJSON(urlBase + "/keys?parentId=" + rootId, function(result){
  	  originalKeyBindings = $.extend(true, {}, result);
  	  configureKeyBindings(result);  	  
    });

    function configureKeyBindings(result) {

      $.each(result, function(a,binding,c){
        if (binding.key == 'null') {
        	$("#keys").append("#");
        	// Don't remove the "null" otherwise we'll assign hash to this category
        }
        $("#keys").append(binding.key + "=" + binding.name +" # node " + binding.id + "\n");
        $("#keyLinks").append("<li style='text-transform:capitalize;' id='list_"+binding.id+"'><a href='/yurl/?rootId=" + binding.id+ "'>" + " " + binding.name + " (<span id='count_"+binding.id+"'></span>)</a></li>");
		$("#count_" + binding.id).text(binding.count);

        $(window).keypress(function(event) {

        	if ($("#keys").is(":focus")) {
        		return;
        	}
        	if (binding.key == String.fromCharCode(event.which)) {
        		var parentId = binding.id;
        		var childId = $("#urls").children()[0].id;
        		var currentRootId = rootId;
        		relate(parentId, childId, currentRootId);
			}
		});
		
      });
      
	  $(window).keypress(function(event) {
	  		var key = String.fromCharCode(event.which);
			if (('_' == key)||('-'==key) ||('j'==key)|| ('n' == key) ) {
				var idOfTop = $("#urls").children()[0].id;
				moveToBottom(idOfTop);
			}
			if (String.fromCharCode(event.which) == '<') {
				console.debug("put back in parent");
				var parentId = parentOfRootId;
				var childId = $("#urls").children()[0].id;
				var currentRootId = rootId;
				relate(parentId, childId, currentRootId);
			}
			if (String.fromCharCode(event.which) == '>') {
				console.debug("remove from list (deal with it later)");
			}
	  });
	  
	  function relate(parentId, childId, currentRootId) {
	    var url = urlBase + "/relate?parentId=" +parentId+"&childId=" +  childId + "&currentParentId=" + currentRootId;
		$.getJSON(url, function(result){})
			.success(function() { 
				removeTop(parentId);
				$("#list_"+parentId).effect("highlight", null, 4000, function() {});
				var count = parseInt($("#count_"+parentId).text()) + 1;
				$("#count_"+parentId).text(count);
				$("#count_"+parentId).css("font-weight","Bold");
				var newCount = parseInt($("#count").text());
				newCount -= 1;
				$("#count").text(newCount);
			})
			.error(function() { alert("error occurred "); })
			.complete(function() { });
	  }

	  function removeTop(parentId) {
	  	var target;
	  	if (parentId == parentOfRootId) {
	  		target = "#up";
	  	} else {
	  		target = "#list_"+parentId;
	  	}
		var options = { to: target, className: "ui-effects-transfer" };
		$($("#urls").children()[0]).effect('transfer',options,500,function() { 
			$($("#urls").children()[0]).effect( "blind",null, 100, function() { $(this).remove(); });
		});
	  	
	  }
    };
    
    ////
    //// Get all recursive categories bindings
    ////
	var url = urlBase + "/categoriesRecursive?parentId=" + nodeIdZero;
	$.getJSON(url, function(result){})
		.success(
			function(data) { 
			      $.each(data, function(a,category,c){
						$("#categoriesRecursive").append("<input type=checkbox value=false name="+category.id +"><a href='/yurl/?rootId="+category.id+"' style='text-transform:capitalize;'>" + category.name + " (" + category.id + ")</a></input>");
						$("#categoriesRecursive").append("<br>");
					});
				//categoriesRecursive
			}
		)
		.error(function() {  })
		.complete(function() {  }
	);


	////
    //// Update the key bindings
    ////
    
    var oldKeyBindings;
    $("#keys").focus(function() {
    	oldKeyBindings = $.trim($("#keys").val());
    }).blur(function() {
    	var newKeyBindings = $.trim($("#keys").val());
    	var i = 1;
    	if (oldKeyBindings === newKeyBindings) {
    		//alert("not changed");
    	} else {
			var url = urlBase + "/keysUpdate?parentId=" + $.url().param('rootId') + "&newKeyBindings=" + encodeURIComponent(newKeyBindings) + "&oldKeyBindings=" + encodeURIComponent(oldKeyBindings);
    		//alert(url);
    	}

		$.getJSON(url, function(result){})
			.success(function(data) {  
				//alert(data);
				configureKeyBindings(data);
			})
			.error(function() { //alert("error occurred "); 
			})
			.complete(function() { });
    });
    
    function getParentId(nodeId) {    	
		$.getJSON(urlBase + "/parent?nodeId=" + nodeId, function(result){
		})
		.success(function(data) {  
			if (data[0] != null) {
				parentOfRootId = data[0].id;
				$("#up").attr("href", "/yurl/?rootId=" + parentOfRootId);
			}
		})
		.error(function() { //alert("error occurred "); 
		})
		.complete(function() { });
    }
    
});

function moveToTop(source) {
	var idToMove = source;
	var firstId = $("#urls").children().first().attr("id");


	if (orderedDescending) {
		// 1 more than latest timestamp
		$.getJSON(urlBase + "/surpassOrdinal?nodeIdToChange=" + idToMove + "&nodeIdToSurpass=" + firstId,
			function(result){
			})
			.success(function(data) {  
				var elem = $("#" + idToMove).remove();
				$("#urls").prepend(elem);
			})
			.error(function() {
				alert("error occurred "); 
			})
			.complete(function() { });
	} else {
		// 1 less than earliest timestamp
		alert('not implemented');
	}
}

function moveToBottom(source) {
	var idToMove = source;
	var lastId = $("#urls").children().last().attr("id");

	if (orderedDescending) {
		$.getJSON(urlBase + "/undercutOrdinal?nodeIdToChange=" + idToMove + "&nodeIdToUndercut=" + lastId, 
			function(result){
			})
			.success(function(data) {  
				var elem = $("#" + idToMove).remove();
				$("#urls").append(elem);
			})
			.error(function() {
				alert("error occurred "); 
			})
			.complete(function() { });
	} else {
		alert('not implemented');
	}
}

function moveUp(source) {
	var first = $("#" + source).prev().attr('id');
	var second = source;
	swap(first, second);
}

function moveDown(source) {
	var first = source;
	var second = $("#" + source).next().attr('id');
	swap(first, second);
}

function swap(firstId, secondId) {
	$.getJSON(urlBase + "/swapOrdinals?firstId=" + firstId + "&secondId=" + secondId, 
		function(result){
		})
		.success(function(data) {  
			$("#" + secondId).after($("#" + firstId));
		})
		.error(function() { 
			alert("error occurred "); 
		})
		.complete(function() { 
		});

}

function sendBatch() {
	var urls = encodeURIComponent($("#urlBatchToSend").val());
	$("#batchStatus").text("Sending new batch");	
	$.getJSON(urlBase + "/batchInsert?rootId=" + rootId + "&urls=" + urls, function(result){})
		.success(function(data) {  
			console.debug(data);
			$("#batchStatus").text("Successfully imported batch, except for ones remaining in text box");
			$("#urlBatchToSend").val("");
			$("#urlBatchToSend").val(data.unsuccessful);
		})
		.error( function(data) { 
			console.debug(data);
			alert("error occurred "); 
		} )
		.complete( function() {} );
}

function getTagSelections() {
	var selected = new Array();
	$('#categoriesRecursive input:checked').each(function() {
		selected.push($(this).attr('name'));
	});
	return JSON.stringify(selected);
}

function tagUrlWithSelections(nodeId) {
	var selections = getTagSelections();
	var url = urlBase + "/relateCategoriesToItem?nodeId=" + nodeId + "&newCategoryIds=" + encodeURIComponent(selections);
	$.getJSON(url, 
		function(result){
		})
		.success(function(data) {  
			//alert("success");
			$("#"+nodeId).remove();
		})
		.error(function() { 
			alert("error occurred "); 
		})
		.complete(function() { 
		}
	);
}

</script>
</head>
<body>

	<table style="width: 100%;table-layout: fixed;">
		<tr>
			<td width="25%" valign=top>
				<a id="up">Up</a>
				<a href="http://netgear.rohidekar.com:4447/yurl/dumpurls">Export</a>
				<div id=rootColor class="buttonize">&nbsp;
				<center>
				<large>
				<h1><span id="count"></span><br></h1>
				<h2><span id="category"></span><br></h2>
				</large>
				</center>
				</div>
				<ol id="keyLinks"  class="buttonize"></ol>
				<font color=grey><div id="status">Init</div></font>
				<textarea id="keys" cols="30" rows="20px" class="buttonize"></textarea>
				<br><br>
				<div id="categoriesRecursive"  class="buttonize">
				</div>
				
			</td>
			<td width="75%">
				<ol id="urls"></ol>
				<input type="button" value="Add URLs" onclick="sendBatch()" /><br>
				<div id="batchStatus"></div>
				<textarea id="urlBatchToSend" rows="20" cols="100"></textarea>
			</td>
		</tr>
		<tr>
			<td></td>
			<td>
			</td>
		</td>
	</table>
</body>
</html>
